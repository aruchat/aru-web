<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>Aru Chat Client</title>
		<link rel = "stylesheet" type = "text/css" href = "css/chat-dark.css" />
		<script src="js/anim.js"></script>
		<script src="js/jquery-3.2.1.min.js"></script>
		<script src="js/socket.io.js"></script>
		<script>
				$(function(){
					$('#connect').click(function(){
						var channels;
						socket = io("http://" + $('#ip').val());
						console.log(socket);
						socket.emit('nickname', $('#nick').val())
						socket.emit('userlist','');
						socket.emit('channels','');
						$(".chat-info").text("Connected to: " + $('#ip').val());
						$(".app-user").text($('#nick').val());

						console.log($('#ip').val());

						socket.on('userlist', function(msg){
							console.log("userlist");
							Aru.deleteUsers();
							console.log(msg);
							var parsed = JSON.parse(msg);
							parsed["users"].forEach(function(entry){
								Aru.addUser(entry["nick"], entry["color"]);
							});
						});

						socket.on('channels', function(msg){
							if(!channels) {
								console.log("channels");
								console.log(msg);
								var parsed = JSON.parse(msg);
								parsed["channels"].forEach(function(entry){
									Aru.addChannel(entry["title"]);
								});
								$(".chat-container-invisible").first().toggleClass('chat-container-invisible chat-container');
								document.getElementsByClassName("chat-channel")[0].setAttribute("selected", "true");
								channels = true;
							}
						});

						$('#chat-input').keydown(function (e){
    					if(e.keyCode == 13){
								var jsonsubmit = '{ "user":"' + $('#nick').val() + '", "channel":"' + $('.chat-container').attr('id') + '", "message":"' + $('#chat-input').val() + '"}';
								socket.emit('message', jsonsubmit);
								$('#chat-input').val('');
    					}
						});

						socket.on('message', function(msg){
							if(channels)
							{
								try {
									var json = JSON.parse(msg);
									Aru.addMessage(json["user"] + " ", json["message"], "#ffffff", json["channel"]);
								}
								catch(err) {
									Aru.addMessage("SERVER ", msg, "#ED145B", $('.chat-container').attr('id'));
								}
							}
						});
				});
			});
		</script>
	</head>
	<body>
		<div>
			<div class="chat-name">Aru Chat Client</div>
			<div class="chat-info">Disconnected</div>
			<div class="app-controls">
				<div class="app-user">User</div>
				<img src="assets/settings.svg">
				<img src="assets/window-minimize.svg">
				<img src="assets/window-maximize.svg">
				<img src="assets/window-close.svg">
			</div>
			<div class="chat-channels" id="channels">
			</div>
			<div id="channel-container">
			</div>
			<div class="chat-online" id="online">
			</div>
			<div class="option-menu">
			</div>
			<input id="chat-input" placeholder="Message #general">
		</div>
		<div id="blurfilter"></div>
		<div id="ip-nick">
			<div class="ip-nick-container" id="diagcontainer">
				<span class="title">Aru</span><br>
				<span class="ip-nick-label">Nickname</span><br>
				<input class="ip-nick-input" id="nick"><br>
				<span class="ip-nick-label">IP</span><br>
				<input class="ip-nick-input" id="ip" value="37.233.101.52:57"><br>
				<button id="connect" onclick="Aru.hideIpNick()">Connect</button>
			</div>
		</div>
	</body>
</html>
